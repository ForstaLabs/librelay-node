<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>storage/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AtlasClient.html">AtlasClient</a><ul class='methods'><li data-type='method'><a href="AtlasClient.html#.authenticateViaCode">authenticateViaCode</a></li><li data-type='method'><a href="AtlasClient.html#.authenticateViaPassword">authenticateViaPassword</a></li><li data-type='method'><a href="AtlasClient.html#.authenticateViaPasswordOtp">authenticateViaPasswordOtp</a></li><li data-type='method'><a href="AtlasClient.html#.authenticateViaToken">authenticateViaToken</a></li><li data-type='method'><a href="AtlasClient.html#.factory">factory</a></li><li data-type='method'><a href="AtlasClient.html#.requestAuthentication">requestAuthentication</a></li><li data-type='method'><a href="AtlasClient.html#fetch">fetch</a></li><li data-type='method'><a href="AtlasClient.html#getDevices">getDevices</a></li><li data-type='method'><a href="AtlasClient.html#getUsers">getUsers</a></li><li data-type='method'><a href="AtlasClient.html#maintainJWT">maintainJWT</a></li><li data-type='method'><a href="AtlasClient.html#resolveTags">resolveTags</a></li><li data-type='method'><a href="AtlasClient.html#resolveTagsBatch">resolveTagsBatch</a></li></ul></li><li><a href="Attachment.html">Attachment</a><ul class='methods'><li data-type='method'><a href="Attachment.html#.fromFile">fromFile</a></li></ul></li><li><a href="MessageReceiver.html">MessageReceiver</a><ul class='methods'><li data-type='method'><a href="MessageReceiver.html#.factory">factory</a></li><li data-type='method'><a href="MessageReceiver.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="MessageReceiver.html#close">close</a></li><li data-type='method'><a href="MessageReceiver.html#connect">connect</a></li><li data-type='method'><a href="MessageReceiver.html#drain">drain</a></li><li data-type='method'><a href="MessageReceiver.html#removeEventListener">removeEventListener</a></li></ul></li><li><a href="MessageSender.html">MessageSender</a><ul class='methods'><li data-type='method'><a href="MessageSender.html#.factory">factory</a></li><li data-type='method'><a href="MessageSender.html#send">send</a></li></ul></li><li><a href="module-errors-NetworkError.html">NetworkError</a></li><li><a href="module-errors-ProtocolError.html">ProtocolError</a></li><li><a href="module-errors-RelayError.html">RelayError</a></li><li><a href="module-errors-UnregisteredUserError.html">UnregisteredUserError</a></li><li><a href="module-eventing-Event.html">Event</a></li><li><a href="module-eventing-EventTarget.html">EventTarget</a><ul class='methods'><li data-type='method'><a href="module-eventing-EventTarget.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="module-eventing-EventTarget.html#removeEventListener">removeEventListener</a></li></ul></li><li><a href="module-eventing-KeyChangeEvent.html">KeyChangeEvent</a></li><li><a href="module-exchange-Exchange.html">Exchange</a><ul class='methods'><li data-type='method'><a href="module-exchange-Exchange.html#addMessageListener">addMessageListener</a></li><li data-type='method'><a href="module-exchange-Exchange.html#decodePayload">decodePayload</a></li><li data-type='method'><a href="module-exchange-Exchange.html#encodePayload">encodePayload</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getAttachments">getAttachments</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getBody">getBody</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getDataProperty">getDataProperty</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getExpiration">getExpiration</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getFlags">getFlags</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getMessageId">getMessageId</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getMessageRef">getMessageRef</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getMessageType">getMessageType</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getSender">getSender</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getSource">getSource</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getSourceDevice">getSourceDevice</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getThreadExpression">getThreadExpression</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getThreadId">getThreadId</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getThreadTitle">getThreadTitle</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getThreadType">getThreadType</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getTimestamp">getTimestamp</a></li><li data-type='method'><a href="module-exchange-Exchange.html#getUserAgent">getUserAgent</a></li><li data-type='method'><a href="module-exchange-Exchange.html#recvMessages">recvMessages</a></li><li data-type='method'><a href="module-exchange-Exchange.html#removeMessageListener">removeMessageListener</a></li><li data-type='method'><a href="module-exchange-Exchange.html#send">send</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setAttachments">setAttachments</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setBody">setBody</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setDataProperty">setDataProperty</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setExpiration">setExpiration</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setFlags">setFlags</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setMessageId">setMessageId</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setMessageRef">setMessageRef</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setMessageType">setMessageType</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setSender">setSender</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setSource">setSource</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setSourceDevice">setSourceDevice</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setThreadExpression">setThreadExpression</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setThreadId">setThreadId</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setThreadTitle">setThreadTitle</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setThreadType">setThreadType</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setTimestamp">setTimestamp</a></li><li data-type='method'><a href="module-exchange-Exchange.html#setUserAgent">setUserAgent</a></li></ul></li><li><a href="module-exchange-ExchangeV1.html">ExchangeV1</a><ul class='methods'><li data-type='method'><a href="module-exchange-ExchangeV1.html#addMessageListener">addMessageListener</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#decodePayload">decodePayload</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#encodePayload">encodePayload</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getAttachments">getAttachments</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getBody">getBody</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getDataProperty">getDataProperty</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getExpiration">getExpiration</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getFlags">getFlags</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getMessageId">getMessageId</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getMessageRef">getMessageRef</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getMessageType">getMessageType</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getSender">getSender</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getSource">getSource</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getSourceDevice">getSourceDevice</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getThreadExpression">getThreadExpression</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getThreadId">getThreadId</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getThreadTitle">getThreadTitle</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getThreadType">getThreadType</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getTimestamp">getTimestamp</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#getUserAgent">getUserAgent</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#recvMessages">recvMessages</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#removeMessageListener">removeMessageListener</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#send">send</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setAttachments">setAttachments</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setBody">setBody</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setDataProperty">setDataProperty</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setExpiration">setExpiration</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setFlags">setFlags</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setMessageId">setMessageId</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setMessageRef">setMessageRef</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setMessageType">setMessageType</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setSender">setSender</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setSource">setSource</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setSourceDevice">setSourceDevice</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setThreadExpression">setThreadExpression</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setThreadId">setThreadId</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setThreadTitle">setThreadTitle</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setThreadType">setThreadType</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setTimestamp">setTimestamp</a></li><li data-type='method'><a href="module-exchange-ExchangeV1.html#setUserAgent">setUserAgent</a></li></ul></li><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="SignalClient.html">SignalClient</a><ul class='methods'><li data-type='method'><a href="SignalClient.html#.factory">factory</a></li></ul></li><li><a href="util.html">util</a></li></ul><h3>Modules</h3><ul><li><a href="module-backing.html">backing</a></li><li><a href="module-errors.html">errors</a></li><li><a href="module-eventing.html">eventing</a><ul class='methods'><li data-type='method'><a href="module-eventing.html#~accept">accept</a></li></ul></li><li><a href="module-exchange.html">exchange</a><ul class='methods'><li data-type='method'><a href="module-exchange.html#.create">create</a></li><li data-type='method'><a href="module-exchange.html#.decode">decode</a></li></ul></li><li><a href="module-util.html">util</a><ul class='methods'><li data-type='method'><a href="module-util.html#~consoleInput">consoleInput</a></li><li data-type='method'><a href="module-util.html#~never">never</a></li><li data-type='method'><a href="module-util.html#~sleep">sleep</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="MessageReceiver.html#event:error">error</a></li><li><a href="MessageReceiver.html#event:keychange">keychange</a></li><li><a href="MessageReceiver.html#event:message">message</a></li><li><a href="MessageReceiver.html#event:receipt">receipt</a></li><li><a href="MessageReceiver.html#event:sent">sent</a></li><li><a href="MessageSender.html#event:error">error</a></li><li><a href="MessageSender.html#event:keychange">keychange</a></li></ul><h3>Global</h3><ul><li><a href="global.html#registerAccount">registerAccount</a></li><li><a href="global.html#registerDevice">registerDevice</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">storage/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// vim: ts=4:sw=4:expandtab

/**
 * @class
 */

const util = require('../util');
const libsignal = require('libsignal');
const process = require('process');
exports.backing = require('./backing');

const defaultBacking = process.env.RELAY_STORAGE_BACKING || 'fs';
const defaultLabel = process.env.RELAY_STORAGE_LABEL || 'default';

const stateNS = 'state';
const sessionNS = 'session';
const preKeyNS = 'prekey';
const signedPreKeyNS = 'signedprekey';
const identityKeyNS = 'identitykey';
const blockedNS = 'blocked';


let _backing;
let _Backing;
let _label = defaultLabel;


function encode(data) {
    const o = {};
    if (data instanceof Buffer) {
        o.type = 'buffer';
        o.data = data.toString('base64');
    } else if (data instanceof ArrayBuffer) {
        throw TypeError("ArrayBuffer not supported");
    } else if (data instanceof Uint8Array) {
        o.type = 'uint8array';
        o.data = Buffer.from(data).toString('base64');
    } else {
        o.data = data;
    }
    return JSON.stringify(o);
}

function decode(obj) {
    const o = JSON.parse(obj);
    if (o.type) {
        if (o.type === 'buffer') {
            return Buffer.from(o.data, 'base64');
        } else if (o.type === 'uint8array') {
            return Uint8Array.from(Buffer.from(o.data, 'base64'));
        } else {
            throw TypeError("Unsupported type: " + o.type);
        }
    } else {
        return o.data;
    }
}

exports.get = async (ns, key, defaultValue) => {
    let data;
    try {
        data = await _backing.get(ns, key);
    } catch(e) {
        if (e instanceof ReferenceError) {
            return defaultValue;
        } else {
            throw e;
        }
    }
    return data &amp;&amp; decode(data);
};
exports.initialize = () => _backing.initialize();
exports.set = (ns, key, value) => _backing.set(ns, key, encode(value));
exports.has = (ns, key, value) => _backing.has(ns, key);
exports.remove = (ns, key) => _backing.remove(ns, key);
exports.keys = (ns, re) => _backing.keys(ns, re);
exports.shutdown = () => _backing.shutdown();

exports.getState = async function(key, defaultValue) {
    return await exports.get(stateNS, key, defaultValue);
};

exports.putState = async function(key, value) {
    return await exports.set(stateNS, key, value);
};

exports.removeState = async function(key) {
    return await _backing.remove(stateNS, key);
};

exports.getOurIdentity = async function() {
    return {
        pubKey: await exports.getState('ourIdentityKey.pub'),
        privKey: await exports.getState('ourIdentityKey.priv')
    };
};

exports.saveOurIdentity = async function(keyPair) {
    await exports.putState('ourIdentityKey.pub', keyPair.pubKey);
    await exports.putState('ourIdentityKey.priv', keyPair.privKey);
};

exports.removeOurIdentity = async function() {
    await exports.removeState('ourIdentityKey.pub');
    await exports.removeState('ourIdentityKey.priv');
};

exports.getOurRegistrationId = async function() {
    return await exports.getState('registrationId');
};

exports.loadPreKey = async function(keyId) {
    if (!await _backing.has(preKeyNS, keyId + '.pub')) {
        return;
    }
    return {
        pubKey: await exports.get(preKeyNS, keyId + '.pub'),
        privKey: await exports.get(preKeyNS, keyId + '.priv')
    };
};

exports.storePreKey = async function(keyId, keyPair) {
    await exports.set(preKeyNS, keyId + '.priv', keyPair.privKey);
    await exports.set(preKeyNS, keyId + '.pub', keyPair.pubKey);
};

exports.removePreKey = async function(keyId) {
    try {
        await _backing.remove(preKeyNS, keyId + '.pub');
        await _backing.remove(preKeyNS, keyId + '.priv');
    } finally {
        // Avoid circular require..
        const hub = require('../hub');
        const signal = await hub.SignalClient.factory();
        await signal.refreshPreKeys();
    }
};

exports.loadSignedPreKey = async function(keyId) {
    if (!await _backing.has(signedPreKeyNS, keyId + '.pub')) {
        return;
    }
    return {
        pubKey: await exports.get(signedPreKeyNS, keyId + '.pub'),
        privKey: await exports.get(signedPreKeyNS, keyId + '.priv')
    };
};

exports.storeSignedPreKey = async function(keyId, keyPair) {
    await exports.set(signedPreKeyNS, keyId + '.priv', keyPair.privKey);
    await exports.set(signedPreKeyNS, keyId + '.pub', keyPair.pubKey);
};

exports.removeSignedPreKey = async function(keyId) {
    await _backing.remove(signedPreKeyNS, keyId + '.pub');
    await _backing.remove(signedPreKeyNS, keyId + '.priv');
};

exports.loadSession = async function(encodedAddr) {
    if (encodedAddr === null || encodedAddr === undefined) {
        throw new Error("Tried to get session for undefined/null addr");
    }
    const data = await exports.get(sessionNS, encodedAddr);
    if (data !== undefined) {
        return libsignal.SessionRecord.deserialize(data);
    }
};

exports.storeSession = async function(encodedAddr, record) {
    if (encodedAddr === null || encodedAddr === undefined) {
        throw new Error("Tried to set session for undefined/null addr");
    }
    await exports.set(sessionNS, encodedAddr, record.serialize());
};

exports.removeSession = async function(encodedAddr) {
    await _backing.remove(sessionNS, encodedAddr);
};

exports.removeAllSessions = async function _removeAllSessions(addr) {
    if (addr === null || addr === undefined) {
        throw new Error("Tried to remove sessions for undefined/null addr");
    }
    for (const x of await _backing.keys(sessionNS, new RegExp(addr + '\\..*'))) {
        await _backing.remove(sessionNS, x);
    }
};

exports.clearSessionStore = async function() {
    for (const x of await _backing.keys(sessionNS)) {
        await _backing.remove(sessionNS, x);
    }
};

exports.isTrustedIdentity = async function(identifier, publicKey) {
    if (!identifier) {
        throw new TypeError("`identifier` required");
    }
    if (!(publicKey instanceof Buffer)) {
        throw new TypeError("publicKey must be Buffer");
    }
    const trustedIdentityKey = await exports.loadIdentity(identifier);
    if (!trustedIdentityKey) {
        console.warn("WARNING: Implicit trust of peer:", identifier);
        await exports.saveIdentity(identifier, publicKey);
    }
    return !trustedIdentityKey || trustedIdentityKey.equals(publicKey);
};

exports.loadIdentity = async function(identifier) {
    if (!identifier) {
        throw new Error("Tried to get identity key for undefined/null key");
    }
    const addr = util.unencodeAddr(identifier)[0];
    return await exports.get(identityKeyNS, addr);
};

exports.saveIdentity = async function(identifier, publicKey) {
    if (!identifier) {
        throw new TypeError("`identifier` required");
    }
    if (!(publicKey instanceof Buffer)) {
        throw new TypeError("publicKey must be Buffer");
    }
    const addr = util.unencodeAddr(identifier)[0];
    const oldPublicKey = await this.loadIdentity(addr);
    if (oldPublicKey &amp;&amp; !oldPublicKey.equals(publicKey)) {
        console.warn("Changing trusted identity key for:", addr);
        await exports.removeAllSessions(addr);
    }
    await exports.set(identityKeyNS, addr, publicKey);
};

exports.removeIdentity = async function(identifier) {
    const addr = util.unencodeAddr(identifier)[0];
    await _backing.remove(identityKeyNS, addr);
    await exports.removeAllSessions(addr);
};

exports.getDeviceIds = async function(addr) {
    if (addr === null || addr === undefined) {
        throw new Error("Tried to get device ids for undefined/null addr");
    }
    const idents = await _backing.keys(sessionNS, new RegExp(addr + '\\..*'));
    return Array.from(idents).map(x => Number(x.split('.')[1]));
};

exports.isBlocked = async function(addr) {
    return await _backing.has(blockedNS, addr);
};

function getBackingClass(name) {
    return {
        redis: exports.backing.RedisBacking,
        postgres: exports.backing.PostgresBacking,
        fs: exports.backing.FSBacking
    }[name];
}

exports.setBacking = function(Backing) {
    if (typeof Backing === 'string') {
        Backing = getBackingClass(Backing);
    }
    if (!Backing) {
        throw new TypeError("Invalid storage backing: " + Backing);
    }
    _Backing = Backing;
    _backing = new Backing(_label);
};

exports.setLabel = function(label) {
    _label = label;
    _backing = new _Backing(label);
};


exports.setBacking(defaultBacking);
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>

<link type="text/css" rel="stylesheet" href="../../css/jsdoc-overrides.css"/>
